<!-- Toast feed back user about changes in back end -->
<div id="userFeedBack" class="toast align-items-center text-white border-0" [ngClass]="userFeedBackStyle" role="alert"
    aria-live="assertive" aria-atomic="true" style="position: absolute; top: 0; left: 0;">
    <div class="d-flex">
        <div class="toast-body">
            {{userFeedBackMessage}}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
            aria-label="Close"></button>
    </div>
</div>

<!--End of Modal feed back user about changes in back end -->


<main id="main">
    <button (click)="preview()" alt="preview"> <i class="bi bi-eye">Preview</i></button>

    <nav *ngIf="totalPages>0">

        <span>Pages ({{currentPage+1}} of {{totalPages}}) => rules number {{totalResults}}</span>
        <ul class="pager" style="display: flex; justify-content: center;">
            <li><a *ngIf="currentPage!=0" (click)="onFilterChange(currentPage-1)" title="Previous page">«</a></li>
            <li *ngFor="let item of [].constructor(this.totalPages); let i=index"
                [ngClass]="i==currentPage?'active':''">
                <a (click)="onFilterChange(i)">{{i+1}}</a>
            </li>
            <li><a *ngIf="currentPage!=totalPages-1" (click)="onFilterChange(currentPage+1)" title="Next page">»</a>
            </li>
        </ul>
    </nav>
    <br>

    <ng-container *ngIf="(rulesDataState$ | async) as result" [ngSwitch]="result.dataState">
        
        <ng-container *ngSwitchCase="RuleStateEnum.LOADING">
            Loading .....
        </ng-container>
        
        <ng-container *ngSwitchCase="RuleStateEnum.ERROR">
            <div class="alert-danger">
                {{result.errorMessage}}
            </div>
        </ng-container>
        
        <ng-container *ngSwitchCase="RuleStateEnum.LOADED">
            <table class="table table-striped table-administration">
                <tbody>
                    <tr>
                        <th>Id</th>
                        <th>Order</th>
                        <th>
                            Part
                            <form [formGroup]="filterFormGroup">
                                <select class="form-control-sm" formControlName="part" style="width: 100px;"
                                    (change)="onFilterChange(0)">
                                    <option value="" disabled="">Select Part</option>
                                    <option value="allPart" selected>All Parts...</option>
                                    <option *ngFor="let p of parts" [ngValue]="p">{{p}} </option>

                                </select>
                            </form>
                        </th>
                        <th>
                            Label
                            <form [formGroup]="filterFormGroup">
                                <select class="form-control-sm" formControlName="label" style="width: 200px;"
                                    (change)="onFilterChange(0)">
                                    <option value="" disabled="">Select Label</option>
                                    <option value="allLabel">All Labels...</option>
                                    <option *ngFor="let l of labels" [ngValue]='l'>{{l}} </option>

                                </select>
                            </form>
                        </th>
                        <th>
                            Condition
                            <form [formGroup]="filterFormGroup">
                                <input style="width: 150px;" class="form-control form-control-sm" type="text"
                                    formControlName="condition" (input)="onFilterChange(0)">
                            </form>
                        </th>
                        <th>
                            Command
                            <form [formGroup]="filterFormGroup">
                                <input style="width: 150px;" class="form-control form-control-sm" type="text"
                                    formControlName="command" (input)="onFilterChange(0)">
                            </form>
                        </th>
                        <th>Mandatory</th>
                        <th>Initial Value</th>
                        <th>
                            Position
                            <form [formGroup]="filterFormGroup">
                                <select class="form-control-sm" formControlName="position" style="width: 100px;"
                                    (change)="onFilterChange(0)">
                                    <option value="" disabled="">Select Position</option>
                                    <option value="allPosition">All Position...</option>
                                    <option *ngFor="let pos of positions" [ngValue]='pos'>{{pos}} </option>
                                </select>
                            </form>
                        </th>
                        <th>Format</th>
                        <th>Example</th>
                        <th>Application</th>
                        <th>
                            <ng-template #Reset>
                                <span style="white-space: normal; max-width:200px;  word-wrap:break-word;">
                                    Reset All Filters
                                </span>
                            </ng-template>
                            <i [ngClass]="filterActive? 'bi-funnel-fill': 'bi-funnel'"
                                style="cursor:pointer; font-size: 1.5em" (click)="resetfilters()" [ngbTooltip]='Reset'
                                class="bi me-1"></i>
                            <ng-template #NewRule>
                                <span style="white-space: normal; max-width:200px;  word-wrap:break-word;">
                                    Add a New Rule
                                </span>
                            </ng-template>
                            <i style="cursor:pointer; font-size: 1.5em" (click)="addNewRule()" [ngbTooltip]='NewRule'
                                class="bi bi-plus-circle me-1"></i>
                        </th>
                    </tr>
                    <td *ngIf="totalPages==0">
                        <div class="text-danger">{{errorMessage}}</div>
                    </td>
                    <tr *ngFor="let r of rules">
                        <td>{{r.id}}</td>
                        <td #order contentEditable (blur)="editRuleOnline(r, order.innerText, 'order')">{{r.order}}</td>
                        <td #part contentEditable (blur)="editRuleOnline(r, part.innerText, 'part')">{{r.part}}</td>
                        <td #label contentEditable (blur)="editRuleOnline(r, label.innerText, 'label')">{{r.label}}</td>
                        <td #condition contentEditable (blur)="editRuleOnline(r, condition.innerText, 'condition')">
                            {{r.condition}}</td>
                        <td #command contentEditable (blur)="editRuleOnline(r, command.innerText, 'command')">
                            {{r.command}}</td>
                        <td>{{r.mandatory}}</td>
                        <td #initialValue contentEditable
                            (blur)="editRuleOnline(r, initialValue.innerText, 'initialValue')">{{r.initialValue}}</td>
                        <td #position contentEditable (blur)="editRuleOnline(r, position.innerText, 'position')">
                            {{r.position}}</td>
                        <td #format contentEditable (blur)="editRuleOnline(r, format.innerText, 'format')">{{r.format}}
                        </td>
                        <td #example contentEditable (blur)="editRuleOnline(r, example.innerText, 'example')">
                            {{r.example}}</td>
                        <td #application contentEditable
                            (blur)="editRuleOnline(r, application.innerText, 'application')">{{r.application}}</td>
                        <td>
                            <ng-template #htmlContent>
                                <span style="white-space: normal; max-width:200px;  word-wrap:break-word;">
                                    {{r.comment}}
                                </span>
                            </ng-template>
                            <a style="cursor:pointer" (click)="deleteRule(r)"> <i class="bi bi-trash p-2"></i></a>

                            <a style="cursor:pointer" (click)="editRule(r)"><i class="bi bi-pencil p-2"></i></a>
                            <a *ngIf="r.comment!=''" [ngbTooltip]="htmlContent"><i
                                    class="bi bi-info-circle p-2"></i></a>
                        </td>
                    </tr>
                </tbody>
            </table>
        </ng-container>
    </ng-container>
    <!-- End-Table-Responsive -->

</main>